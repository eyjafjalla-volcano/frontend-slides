name: Redroid Tailscale Docker

on:
  push:
    branches: [ main ]
  workflow_dispatch: 

jobs:
  run-cloud-phone:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kernel Modules (å®‰å“å†…æ ¸ä¾èµ–)
        run: |
          sudo apt-get update
          sudo apt-get install -y dkms linux-headers-$(uname -r) git
          git clone https://github.com/Etaash-mathamsetty/anbox-modules.git
          cd anbox-modules
          # æ·»åŠ  #include <linux/version.h> å¦‚æœéœ€è¦ï¼ˆå‡è®¾ binder.c å·²åŒ…å« freezer.hï¼‰
          sed -i '/#include <linux\/freezer.h>/a #include <linux\/version.h>' binder/binder.c
          # åŒ…è£¹ freezer_do_not_count()
          sed -i 's/freezer_do_not_count();/#if (LINUX_VERSION_CODE < KERNEL_VERSION(6,1,0))\nfreezer_do_not_count();\n#endif/' binder/binder.c
          # ä¿®æ”¹ prepare_to_wait çš„ TASK_INTERRUPTIBLE
          sed -i 's/TASK_INTERRUPTIBLE);/#if (LINUX_VERSION_CODE < KERNEL_VERSION(6,1,0))\nTASK_INTERRUPTIBLE\n#else\nTASK_INTERRUPTIBLE|TASK_FREEZABLE\n#endif);/' binder/binder.c
          # åŒ…è£¹ freezer_count()
          sed -i 's/freezer_count();/#if (LINUX_VERSION_CODE < KERNEL_VERSION(6,1,0))\nfreezer_count();\n#endif/' binder/binder.c
          sudo cp -rT binder /usr/src/anbox-binder-1
          sudo dkms install anbox-binder/1
          sudo modprobe binder_linux devices=binder,hwbinder,vndbinder || true

      - name: Run Tailscale & Redroid via Docker
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          # æ‰‹åŠ¨åˆ›å»º TUN è®¾å¤‡ï¼Œé˜²æ­¢ Tailscale æ‰¾ä¸åˆ°ç½‘å¡è€Œå´©æºƒ
          sudo mkdir -p /dev/net
          sudo mknod /dev/net/tun c 10 200 || true
          sudo chmod 666 /dev/net/tun

          echo "ğŸš€ æ­£åœ¨å¯åŠ¨ Tailscale å®¹å™¨..."
          docker run -d --name tailscale --privileged \
            --cap-add=NET_ADMIN \
            --cap-add=NET_RAW \
            -v /dev/net/tun:/dev/net/tun \
            -e TS_AUTHKEY=$TAILSCALE_AUTHKEY \
            -e TS_HOSTNAME=github-redroid \
            -e TS_USERSPACE=false \
            -e TS_STATE_DIR=/var/lib/tailscale \
            tailscale/tailscale:latest

          echo "â³ ç­‰å¾… Tailscale ç»„ç½‘æˆåŠŸ (15ç§’)..."
          sleep 15
          
          if [ "$(docker inspect -f '{{.State.Running}}' tailscale)" != "true" ]; then
            echo "âŒ Tailscale å¯åŠ¨å¤±è´¥ï¼æ‰“å°å´©æºƒæ—¥å¿—ï¼š"
            docker logs tailscale
            exit 1
          fi

          TS_IP=$(docker exec tailscale tailscale ip -4 || echo "IPè·å–å¤±è´¥")
          echo "======================================================"
          echo "âœ… Tailscale Docker å·²ä¸Šçº¿ï¼"
          echo "ğŸ‘‰ åˆ†é…çš„å†…ç½‘ IP: $TS_IP"
          echo "ğŸ‘‰ è¿æ¥å‘½ä»¤: adb connect $TS_IP:5555"
          echo "======================================================"

          echo "ğŸš€ æ­£åœ¨å¯åŠ¨ Redroid å®¹å™¨..."
          docker run -d --name redroid --privileged --pull always \
            --network container:tailscale \
            erstt/redroid:11.0.0_ndk_ChromeOS \
            androidboot.redroid_gpu_mode=guest \
            androidboot.use_memfd=1 \
            androidboot.redroid_width=720 \
            androidboot.redroid_height=1280 \
            androidboot.redroid_fps=15

      - name: Wait for Redroid Booting
        run: |
          echo "â³ æ­£åœ¨ç­‰å¾… Redroid ç³»ç»Ÿå¼€æœº..."
          COUNT=0
          
          while true; do
            TS_STATUS=$(docker inspect -f '{{.State.Running}}' tailscale 2>/dev/null)
            RD_STATUS=$(docker inspect -f '{{.State.Running}}' redroid 2>/dev/null)
            
            if [ "$TS_STATUS" != "true" ]; then
              echo "âŒ Tailscale å®¹å™¨æ„å¤–å´©æºƒï¼æ—¥å¿—å¦‚ä¸‹ï¼š"
              docker logs tailscale
              exit 1
            fi
            
            if [ "$RD_STATUS" != "true" ]; then
              echo "âŒ Redroid å®¹å™¨æ„å¤–å´©æºƒï¼æ—¥å¿—å¦‚ä¸‹ï¼š"
              docker logs redroid
              exit 1
            fi

            OUT=$(timeout 5 docker exec redroid getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "timeout")
            
            if [ "$OUT" == "1" ]; then
              echo "ğŸ‰ Redroid å·²å¯åŠ¨å®Œæ¯•å¹¶å‡†å¤‡å°±ç»ªï¼"
              break
            fi
            
            echo "ğŸ‘€ æ£€æŸ¥ä¸­... çŠ¶æ€: ${OUT:-'æœªå°±ç»ª'} (å·²ç­‰å¾… $((COUNT * 5)) ç§’)"
            
            sleep 5
            COUNT=$((COUNT+1))
            
            if [ $COUNT -gt 36 ]; then
              echo "âŒ Redroid å¯åŠ¨è¶…æ—¶ï¼æ‰“å° Android å®¹å™¨æ—¥å¿—æ’é”™ï¼š"
              docker logs redroid | tail -n 50
              exit 1
            fi
          done

      - name: Keep Alive for Remote Debugging
        run: |
          echo "ç°åœ¨ä½ å¯ä»¥å°½æƒ…åœ¨æ‰‹æœºä¸Šé€šè¿‡ Tailscale è¿œç¨‹è¿æ¥å’Œæµ‹è¯•äº†ï¼"
          echo "å®¹å™¨å°†åœ¨ 1 å°æ—¶åè‡ªåŠ¨é”€æ¯ (é˜²æ­¢è¿‡åº¦æ¶ˆè€— GitHub Action æ—¶é•¿)..."
          sleep 3600
