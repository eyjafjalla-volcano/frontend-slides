name: Android Emulator with Tailscale

on:
  push:
    branches: [ main ]
  workflow_dispatch: 

jobs:
  run-cloud-emulator:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          hostname: github-android-emulator

      - name: Get Tailscale IP
        id: tailscale_ip
        run: |
          TS_IP=$(tailscale ip -4)
          echo "TS_IP=$TS_IP" >> $GITHUB_OUTPUT
          echo "======================================================"
          echo "✅ Tailscale 已上线！"
          echo "👉 分配的内网 IP: $TS_IP"
          echo "👉 连接命令: adb connect $TS_IP:5555"
          echo "======================================================"

      - name: Run Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          profile: pixel_4
          ram-size: 2048M
          disk-size: 2048M
          emulator-options: -no-snapshot-save -noaudio -no-boot-anim -camera-back none -gpu swiftshader_indirect
          disable-animations: true
          script: |
            echo "⏳ 正在等待 Emulator 系统开机..."
            adb wait-for-device
            COUNT=0
            while true; do
              OUT=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "未就绪")
              if [ "$OUT" == "1" ]; then
                echo "🎉 Emulator 已启动完毕并准备就绪！"
                break
              fi
              echo "👀 检查中... 状态: ${OUT:-'未就绪'} (已等待 $((COUNT * 5)) 秒)"
              sleep 5
              COUNT=$((COUNT+1))
              if [ $COUNT -gt 36 ]; then
                echo "❌ Emulator 启动超时！"
                adb logcat | tail -n 50
                exit 1
              fi
            done
            # 暴露 ADB 到 Tailscale IP（默认已通过 Tailscale 网络可用）
            echo "现在你可以通过 Tailscale 远程连接 ADB 了！"
            echo "容器将在 1 小时后自动销毁..."
            sleep 3600
