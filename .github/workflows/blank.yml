name: Android Emulator with Tailscale (ARM64 Translation)

on:
  workflow_dispatch:
    inputs:
      api_level:
        description: 'Android API Level'
        required: true
        type: choice
        options:
          - '28'
          - '29'
          - '30'
          - '31'
          - '32'
        default: '30'
      runtime_minutes:
        description: 'æ¨¡æ‹Ÿå™¨è¿è¡Œæ—¶é—´ (åˆ†é’Ÿ)'
        required: true
        type: number
        default: '60'
      enable_arm_translation:
        description: 'å¯ç”¨ ARM64 åº”ç”¨è½¬è¯‘'
        required: true
        type: boolean
        default: true

jobs:
  run-cloud-emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: æœ€å¤§åŒ–è¿è¡Œå™¨ç£ç›˜ç©ºé—´
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
          sudo apt-get autoremove -y && sudo apt-get autoclean -y
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*
          sudo docker system prune -a -f || true
          echo "âœ… ç£ç›˜ç©ºé—´ä¼˜åŒ–å®Œæˆï¼š$(df -h / | tail -1 | awk '{print $4}')"

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpulse0 \
            libxcb1 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxkbcommon-x11-0 \
            libgl1-mesa-glx \
            libegl1-mesa \
            libdbus-1-3

      - name: å¯ç”¨ KVM (å¢å¼ºç‰ˆ)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          ls -la /dev/kvm
          chmod 666 /dev/kvm
          echo "âœ… KVM å·²å¯ç”¨å¹¶éªŒè¯"

      - name: é…ç½® Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          hostname: github-android-emulator-${{ github.run_id }}

      - name: è·å– Tailscale IP
        id: tailscale_ip
        run: |
          TS_IP=$(tailscale ip -4)
          echo "TS_IP=$TS_IP" >> $GITHUB_OUTPUT
          echo "======================================================"
          echo "âœ… Tailscale å·²ä¸Šçº¿ï¼"
          echo "ğŸ‘‰ åˆ†é…çš„å†…ç½‘ IP: $TS_IP"
          echo "ğŸ‘‰ ADB è¿æ¥å‘½ä»¤: adb connect $TS_IP:5555"
          echo "======================================================"

      - name: è¿è¡Œ Android æ¨¡æ‹Ÿå™¨ (æ”¯æŒ ARM64 è½¬è¯‘)
        uses: reactivecircus/android-emulator-runner@v2
        timeout-minutes: ${{ github.event.inputs.runtime_minutes }}
        with:
          api-level: ${{ github.event.inputs.api_level }}
          target: ${{ github.event.inputs.enable_arm_translation == true && 'google_apis' || 'default' }}
          arch: x86_64
          profile: pixel_4
          ram-size: 4096M
          disk-size: 8192M
          hw-acceleration: true
          emulator-options: >-
            -no-snapshot-save
            -no-boot-anim
            -camera-back none
            -gpu swiftshader_indirect
            -no-snapshot
            -no-snapshot-load
          disable-animations: true
          script: |
            echo "â³ æ­£åœ¨ç­‰å¾… Emulator ç³»ç»Ÿå¼€æœº..."
            
            # ç­‰å¾… ADB è®¾å¤‡å°±ç»ª
            adb wait-for-device
            
            # æ£€æŸ¥boot_completedçŠ¶æ€
            COUNT=0
            MAX_COUNT=40
            while [ $COUNT -lt $MAX_COUNT ]; do
              OUT=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "")
              if [ "$OUT" == "1" ]; then
                echo "ğŸ‰ Emulator å·²å¯åŠ¨å®Œæ¯•å¹¶å‡†å¤‡å°±ç»ªï¼"
                break
              fi
              echo "ğŸ‘€ æ£€æŸ¥ä¸­... çŠ¶æ€: ${OUT:-'æœªå°±ç»ª'} (å·²ç­‰å¾… $((COUNT * 5)) ç§’)"
              sleep 5
              COUNT=$((COUNT + 1))
            done
            
            if [ $COUNT -ge $MAX_COUNT ]; then
              echo "âŒ Emulator å¯åŠ¨è¶…æ—¶ï¼"
              echo "--- æœ€å50è¡Œ logcat ---"
              adb logcat -d | tail -n 50
              echo "--- Emulator çŠ¶æ€ ---"
              adb devices -l
              exit 1
            fi
            
            # é…ç½® ADB over TCP
            echo "--- é…ç½® ADB over TCP ---"
            adb tcpip 5555
            sleep 2
            
            # è¾“å‡ºè¿æ¥ä¿¡æ¯
            TS_IP="${{ steps.tailscale_ip.outputs.TS_IP }}"
            echo "======================================================"
            echo "âœ… Android Emulator å·²å°±ç»ªï¼"
            echo "ğŸ“± è®¾å¤‡ä¿¡æ¯:"
            adb shell getprop ro.build.version.release
            adb shell getprop ro.product.model
            echo "ğŸŒ Tailscale IP: $TS_IP"
            echo "ğŸ”Œ è¿œç¨‹è¿æ¥å‘½ä»¤:"
            echo "   adb connect $TS_IP:5555"
            echo "======================================================"
            
            # ä¿æŒè¿è¡Œ
            echo "â³ æ¨¡æ‹Ÿå™¨å°†åœ¨ ${{ github.event.inputs.runtime_minutes }} åˆ†é’Ÿåè‡ªåŠ¨é”€æ¯..."
            REMAINING=$(( ${{ github.event.inputs.runtime_minutes }} * 60 ))
            while [ $REMAINING -gt 0 ]; do
              # æ£€æŸ¥è®¾å¤‡æ˜¯å¦ä»ç„¶åœ¨çº¿
              if ! adb devices | grep -q "device$"; then
                echo "âš ï¸ è­¦å‘Š: è®¾å¤‡ä¼¼ä¹å·²æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥..."
                adb start-server
                adb tcpip 5555
              fi
              sleep 60
              REMAINING=$((REMAINING - 60))
              if [ $((REMAINING % 300)) -eq 0 ]; then
                echo "ğŸ’¡ å‰©ä½™è¿è¡Œæ—¶é—´: $((REMAINING / 60)) åˆ†é’Ÿ"
              fi
            done
            
            echo "âœ… è¿è¡Œæ—¶é—´å·²åˆ°ï¼Œå·¥ä½œæµå³å°†ç»“æŸ"

      - name: è¾“å‡ºè°ƒè¯•ä¿¡æ¯
        if: always()
        run: |
          echo "--- å·¥ä½œæµæ‰§è¡Œå®Œæˆ ---"
          echo "Tailscale IP: ${{ steps.tailscale_ip.outputs.TS_IP }}"
          echo "è¿è¡ŒçŠ¶æ€: ${{ job.status }}"
